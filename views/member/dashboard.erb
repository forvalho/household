<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-tasks"></i> <%= current_member.name %>'s Chores</h1>
            <% if admin_logged_in? %>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                    <i class="fas fa-plus"></i> Add New Task
                </button>
            <% end %>
        </div>
    </div>
</div>

<!-- Chores Board -->
<div class="row gap-3">
    <div class="col">
        <div class="kanban-column">
            <h5 class="text-center mb-3">
                <i class="fas fa-inbox text-secondary"></i> Unassigned
            </h5>
            <div id="unassigned-column" class="task-list" data-status="unassigned">
                <% @unassigned_tasks.each do |task| %>
                    <%= erb :'common/task_card', locals: { task: task } %>
                <% end %>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kanban-column">
            <h5 class="text-center mb-3">
                <i class="fas fa-list text-primary"></i> To Do
            </h5>
            <div id="todo-column" class="task-list" data-status="todo">
                <% @member_tasks.select { |t| t.status == 'todo' }.each do |task| %>
                    <%= erb :'common/task_card', locals: { task: task } %>
                <% end %>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kanban-column">
            <h5 class="text-center mb-3">
                <i class="fas fa-spinner text-warning"></i> In Progress
            </h5>
            <div id="in-progress-column" class="task-list" data-status="in_progress">
                <% @member_tasks.select { |t| t.status == 'in_progress' }.each do |task| %>
                    <%= erb :'common/task_card', locals: { task: task } %>
                <% end %>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kanban-column">
            <h5 class="text-center mb-3">
                <i class="fas fa-check-circle text-success"></i> Done
            </h5>
            <div id="done-column" class="task-list" data-status="done">
                <% @member_tasks.select { |t| t.status == 'done' }.each do |task| %>
                    <%= erb :'common/task_card', locals: { task: task } %>
                <% end %>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kanban-column">
            <h5 class="text-center mb-3">
                <i class="fas fa-times-circle text-danger"></i> Skipped
            </h5>
            <div id="skipped-column" class="task-list" data-status="skipped">
                <% @member_tasks.select { |t| t.status == 'skipped' }.each do |task| %>
                    <%= erb :'common/task_card', locals: { task: task } %>
                <% end %>
            </div>
        </div>
    </div>
</div>

<!-- New Task Modal -->
<% if admin_logged_in? %>
<div class="modal fade" id="newTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Add New Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/admin/tasks">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Task Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="member_id" class="form-label">Assign To</label>
                                <select class="form-select" id="member_id" name="member_id" required>
                                    <option value="">Select Member</option>
                                    <% Member.where(active: true).each do |member| %>
                                        <option value="<%= member.id %>" <%= 'selected' if member.id == current_member.id %>>
                                            <%= member.name %>
                                        </option>
                                    <% end %>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="difficulty" class="form-label">Difficulty</label>
                                <select class="form-select" id="difficulty" name="difficulty">
                                    <option value="easy">Easy (1 point)</option>
                                    <option value="medium" selected>Medium (2 points)</option>
                                    <option value="hard">Hard (3 points)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <input type="text" class="form-control" id="category" name="category" placeholder="e.g., Kitchen, Bathroom">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="due_date" class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="due_date" name="due_date">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<% end %>

<!-- Task Action Modals -->
<div class="modal fade" id="completeTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success"></i> Complete Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="completeTaskForm">
                <div class="modal-body">
                    <p>Are you sure you want to mark this task as complete?</p>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Any additional notes about the completion..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Complete Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="skipTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle text-warning"></i> Skip Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="skipTaskForm">
                <div class="modal-body">
                    <p>Please provide a reason for skipping this task:</p>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" required placeholder="Why are you skipping this task?"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-times"></i> Skip Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Sortable for each column
    const columns = document.querySelectorAll('.task-list');
    columns.forEach(column => {
        new Sortable(column, {
            group: 'tasks',
            animation: 150,
            ghostClass: 'dragging',
            onEnd: function(evt) {
                const taskId = evt.item.dataset.taskId;
                const newStatus = evt.to.dataset.status;

                fetch(`/tasks/${taskId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the task card's status
                        evt.item.dataset.status = newStatus;
                    } else {
                        // Revert the move if it failed
                        evt.from.appendChild(evt.item);
                    }
                })
                .catch(error => {
                    console.error('Error updating task status:', error);
                    evt.from.appendChild(evt.item);
                });
            }
        });
    });

    // Handle complete task modal
    const completeTaskModal = document.getElementById('completeTaskModal');
    completeTaskModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const taskId = button.dataset.taskId;
        const form = document.getElementById('completeTaskForm');
        form.action = `/tasks/${taskId}/complete`;
    });

    // Handle skip task modal
    const skipTaskModal = document.getElementById('skipTaskModal');
    skipTaskModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const taskId = button.dataset.taskId;
        const form = document.getElementById('skipTaskForm');
        form.action = `/tasks/${taskId}/skip`;
    });
});
</script>
