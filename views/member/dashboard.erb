<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <% if current_member.avatar_url.present? %>
                  <img src="<%= current_member.avatar_url %>" class="title-avatar me-3" alt="<%= current_member.name %>">
              <% else %>
                  <div class="title-avatar me-3"><%= current_member.name.first.upcase %></div>
              <% end %>
              <h1 class="mb-0"><%= current_member.name %>'s Tasks</h1>
            </div>
            <% if admin_logged_in? %>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newTaskModal">
                    <i class="fas fa-plus"></i> Add New Task
                </button>
            <% end %>
        </div>
    </div>
</div>

<!-- Tasks Board -->
<div class="row gap-3 kanban-board">
    <div class="col">
        <div class="kanban-column">
            <h5 class="text-center mb-3">
                <i class="fas fa-clipboard-list text-info"></i> Available Tasks
            </h5>
            <div id="templates-column" class="task-list">
                <% @task_templates.each do |template| %>
                    <div class="task-card difficulty-<%= template.medal %>" data-template-id="<%= template.id %>">
                        <div class="card-body d-flex flex-column">
                            <!-- Top Section: Title & Points -->
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0 fw-bold"><%= template.title %></h6>
                                <% if template.generic_task? %>
                                    <span class="badge bg-secondary" title="Custom difficulty">
                                        <i class="fas fa-edit"></i> Custom
                                    </span>
                                <% else %>
                                    <span class="medal-badge" title="<%= pluralize(template.points_value, 'point') %>">
                                        <i class="fas fa-medal medal-<%= template.medal %>"></i>
                                    </span>
                                <% end %>
                            </div>

                            <!-- Optional Description -->
                            <% if template.generic_task? %>
                                <p class="small text-muted mb-2">Create your own task with custom title and difficulty</p>
                            <% elsif template.description.present? %>
                                <p class="small text-muted mb-2"><%= template.description %></p>
                            <% end %>

                            <!-- Bottom Section: Actions & Tags -->
                            <div class="mt-auto">
                                <!-- Actions: Assign Template -->
                                <div class="task-actions-container mb-2">
                                    <% if template.generic_task? %>
                                        <!-- Generic Task: Show modal button -->
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#genericTaskModal">
                                            <i class="fas fa-user-plus"></i>
                                            <span class="ms-2">Assign Task</span>
                                        </button>
                                    <% else %>
                                        <!-- Regular Template: Show dropdown -->
                                        <!-- Assignee Dropdown -->
                                        <div class="assignee-selector dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle assignee-dropdown-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-user-plus"></i>
                                                <span class="ms-2">Assign Task</span>
                                            </button>
                                            <ul class="dropdown-menu assignee-dropdown-menu">
                                                <% Member.all.order(:name).each do |member| %>
                                                    <li>
                                                        <form action="/task-templates/<%= template.id %>/assign" method="post" class="assignee-form">
                                                            <input type="hidden" name="member_id" value="<%= member.id %>">
                                                            <button type="submit" class="dropdown-item" <%= 'disabled' unless admin_logged_in? || member.id == current_member.id %>>
                                                                <% if member.avatar_url.present? %>
                                                                    <img src="<%= member.avatar_url %>" class="user-avatar me-2" alt="<%= member.name %>">
                                                                <% else %>
                                                                    <div class="user-avatar me-2"><%= member.name.first.upcase %></div>
                                                                <% end %>
                                                                <%= member.name %>
                                                            </button>
                                                        </form>
                                                    </li>
                                                <% end %>
                                            </ul>
                                        </div>
                                    <% end %>
                                </div>

                                <!-- Tags: Category -->
                                <div class="task-tags">
                                    <% if template.category.present? %>
                                        <span class="badge bg-secondary"><%= template.category %></span>
                                    <% end %>
                                </div>
                            </div>
                        </div>
                    </div>
                <% end %>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kanban-column">
            <h5 class="text-center mb-3">
                <i class="fas fa-list text-primary"></i> To Do
            </h5>
            <div id="todo-column" class="task-list" data-status="todo">
                <% @member_tasks.select { |t| t.status == 'todo' }.each do |task| %>
                    <%= erb :'common/task_card', locals: { task: task } %>
                <% end %>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kanban-column">
            <h5 class="text-center mb-3">
                <i class="fas fa-spinner text-warning"></i> In Progress
            </h5>
            <div id="in-progress-column" class="task-list" data-status="in_progress">
                <% @member_tasks.select { |t| t.status == 'in_progress' }.each do |task| %>
                    <%= erb :'common/task_card', locals: { task: task } %>
                <% end %>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="kanban-column">
            <h5 class="text-center mb-3">
                <i class="fas fa-check-circle text-success"></i> Done
            </h5>
            <div id="done-column" class="task-list" data-status="done">
                <% @member_tasks.select { |t| t.status == 'done' }.each do |task| %>
                    <%= erb :'common/task_card', locals: { task: task } %>
                <% end %>
            </div>
        </div>
    </div>
</div>

<!-- New Task Modal -->
<% if admin_logged_in? %>
<div class="modal fade" id="newTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Add New Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/admin/tasks">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Task Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="member_id" class="form-label">Assign To</label>
                                <select class="form-select" id="member_id" name="member_id" required>
                                    <option value="">Select Member</option>
                                    <% Member.where(active: true).each do |member| %>
                                        <option value="<%= member.id %>" <%= 'selected' if member.id == current_member.id %>>
                                            <%= member.name %>
                                        </option>
                                    <% end %>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="difficulty" class="form-label">Difficulty</label>
                                <select class="form-select" id="difficulty" name="difficulty">
                                    <option value="bronze">Bronze (1 point)</option>
                                    <option value="silver" selected>Silver (3 points)</option>
                                    <option value="gold">Gold (5 points)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category</label>
                                <input type="text" class="form-control" id="category" name="category" placeholder="e.g., Kitchen, Bathroom">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="due_date" class="form-label">Due Date</label>
                                <input type="date" class="form-control" id="due_date" name="due_date">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<% end %>

<!-- Task Action Modals -->
<div class="modal fade" id="completeTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success"></i> Complete Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="completeTaskForm">
                <div class="modal-body">
                    <p>Are you sure you want to mark this task as complete?</p>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Any additional notes about the completion..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Complete Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="skipTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle text-warning"></i> Skip Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="skipTaskForm">
                <div class="modal-body">
                    <p>Please provide a reason for skipping this task:</p>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason</label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" required placeholder="Why are you skipping this task?"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-times"></i> Skip Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Generic Task Modal -->
<div class="modal fade" id="genericTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Create Custom Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/custom-tasks">
                <div class="modal-body">
                    <p class="text-muted mb-3">Create a custom task with your own title and difficulty level.</p>

                    <div class="mb-3">
                        <label for="custom_title" class="form-label">Task Title</label>
                        <input type="text" class="form-control" id="custom_title" name="title" required placeholder="e.g., Clean garage, Organize closet">
                    </div>

                    <div class="mb-3">
                        <label class="form-label d-block">Difficulty</label>
                        <div class="difficulty-radio-group">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="difficulty" id="difficulty_bronze" value="bronze" checked>
                                <label class="form-check-label" for="difficulty_bronze">
                                    <i class="fas fa-medal medal-bronze fa-2x"></i>
                                    <div>Bronze</div>
                                    <small class="text-muted">(1 point)</small>
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="difficulty" id="difficulty_silver" value="silver">
                                <label class="form-check-label" for="difficulty_silver">
                                    <i class="fas fa-medal medal-silver fa-2x"></i>
                                    <div>Silver</div>
                                    <small class="text-muted">(3 points)</small>
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="difficulty" id="difficulty_gold" value="gold">
                                <label class="form-check-label" for="difficulty_gold">
                                    <i class="fas fa-medal medal-gold fa-2x"></i>
                                    <div>Gold</div>
                                    <small class="text-muted">(5 points)</small>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="custom_category" class="form-label">Category</label>
                        <select class="form-select" id="custom_category" name="category" required>
                            <option value="General" selected>General</option>
                            <option value="Kitchen">Kitchen</option>
                            <option value="Laundry">Laundry</option>
                            <option value="Yard">Yard</option>
                            <option value="Bathroom">Bathroom</option>
                            <option value="Bedroom">Bedroom</option>
                            <option value="Living Room">Living Room</option>
                            <option value="Office">Office</option>
                            <option value="Garage">Garage</option>
                        </select>
                    </div>

                    <input type="hidden" name="member_id" value="<%= current_member.id %>">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Auto-hide flash messages after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
        var flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(function(message) {
            setTimeout(function() {
                new bootstrap.Alert(message).close();
            }, 5000);
        });

        // Fix for task card dropdown z-index issue
        var taskCardDropdowns = document.querySelectorAll('.task-card .dropdown');
        taskCardDropdowns.forEach(function(dd) {
            dd.addEventListener('show.bs.dropdown', function () {
                var taskCard = dd.closest('.task-card');
                if (taskCard) {
                    taskCard.style.zIndex = 100;
                }
            });
            dd.addEventListener('hide.bs.dropdown', function () {
                var taskCard = dd.closest('.task-card');
                if (taskCard) {
                    taskCard.style.zIndex = 'auto';
                }
            });
        });
    });

    // JavaScript for the custom task modal
    document.addEventListener('DOMContentLoaded', function() {
        const customTaskModal = document.getElementById('genericTaskModal');
        if (customTaskModal) {
            customTaskModal.addEventListener('show.bs.modal', function() {
                // Reset form when modal opens
                document.getElementById('custom-task-title').value = '';
                document.getElementById('custom-task-difficulty-bronze').checked = true;
                document.getElementById('custom-task-category').value = 'General';
            });
        }
    });
</script>
